#
# This source file is part of the Stanford Spezi open source project
#
# SPDX-FileCopyrightText: 2023 Stanford University and the project authors (see CONTRIBUTORS.md)
#
# SPDX-License-Identifier: MIT
#

name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: Build-and-Test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package_tests:
    name: Build and Test Swift Package ${{ matrix.platform.name }} (${{ matrix.config }})
    uses: StanfordBDHG/.github/.github/workflows/xcodebuild-or-fastlane.yml@v2
    strategy:
      matrix:
        config: [Debug, Release]
        platform:
          - name: iOS
            destination: 'platform=iOS Simulator,name=iPhone 17 Pro'
          - name: macOS
            destination: 'platform=macOS,arch=arm64'
          - name: visionOS
            destination: 'platform=visionOS Simulator,name=Apple Vision Pro'
      fail-fast: false
    with:
      runsonlabels: '["macOS", "self-hosted"]'
      scheme: SpeziLLM-Package
      destination: ${{ matrix.platform.destination }}
      buildConfig: ${{ matrix.config }}
      resultBundle: ${{ format('SpeziLLM-{0}-{1}.xcresult', matrix.platform.name, matrix.config) }}
      artifactname: ${{ format('SpeziLLM-{0}-{1}.xcresult', matrix.platform.name, matrix.config) }}
  ui_tests:
    name: Build and Test UI Tests ${{ matrix.platform.name }} (${{ matrix.config }})
    uses: StanfordBDHG/.github/.github/workflows/xcodebuild-or-fastlane.yml@v2
    strategy:
      matrix:
        config: [Debug, Release]
        platform:
          - name: iOS
            destination: 'platform=iOS Simulator,name=iPhone 17 Pro'
          - name: iPad
            destination: 'platform=iOS Simulator,name=iPad Air 11-inch (M3)'
          - name: visionOS
            destination: 'platform=visionOS Simulator,name=Apple Vision Pro'
      fail-fast: false
    with:
      runsonlabels: '["macOS", "self-hosted"]'
      path: 'Tests/UITests'
      scheme: TestApp
      destination: ${{ matrix.platform.destination }}
      buildConfig: ${{ matrix.config }}
      resultBundle: ${{ format('TestApp-{0}-{1}.xcresult', matrix.platform.name, matrix.config) }}
      artifactname: ${{ format('TestApp-{0}-{1}.xcresult', matrix.platform.name, matrix.config) }}
  uploadcoveragereport:
    name: Upload Coverage Report
    needs: [package_tests, ui_tests]
    uses: StanfordBDHG/.github/.github/workflows/create-and-upload-coverage-report.yml@v2
    with:
      coveragereports: SpeziLLM-*.xcresult TestApp-*.xcresult
    secrets:
      token: ${{ secrets.CODECOV_TOKEN }}
  buildandtest_fognode:
    name: Build and Test Fog Node
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Set up Docker Compose
        uses: docker/setup-buildx-action@v2
      - name: Build and Start Docker Services
        run: |
          cd FogNode
          docker compose -f docker-compose.dev.yml up --build -d
      - name: Wait for Services to Start
        run: |
          cd FogNode
          MAX_WAIT=30
          WAIT_TIME=0

          while [ "$(docker compose -f docker-compose.dev.yml ps --filter "status=running" | grep -c "Up")" -lt 4 ]; do
            if [ $WAIT_TIME -ge $MAX_WAIT ]; then
              echo "Timeout: Not all services are up after $MAX_WAIT seconds."
              docker compose -f docker-compose.dev.yml ps
              exit 1
            fi
            echo "Waiting for services to start... ($WAIT_TIME seconds elapsed)"
            docker logs fognode-auth-service-1
            sleep 1
            WAIT_TIME=$((WAIT_TIME + 1))
          done

          echo "All services are up and running!"
      - name: Verify Container Status
        run: |
          cd FogNode
      
          # Check for problematic containers
          EXITED_COUNT=$(docker compose -f docker-compose.dev.yml ps --filter "status=exited" -q | wc -l)
          RESTARTING_COUNT=$(docker compose -f docker-compose.dev.yml ps --filter "status=restarting" -q | wc -l)
          DEAD_COUNT=$(docker compose -f docker-compose.dev.yml ps --filter "status=dead" -q | wc -l)
      
          # Log current counts for visibility
          echo "Exited Containers: $EXITED_COUNT"
          echo "Restarting Containers: $RESTARTING_COUNT"
          echo "Dead Containers: $DEAD_COUNT"
      
          # Fail if any problematic containers are detected
          if [ "$EXITED_COUNT" -gt 0 ] || [ "$RESTARTING_COUNT" -gt 0 ] || [ "$DEAD_COUNT" -gt 0 ]; then
            echo "Error: One or more containers are in a problematic state (exited, restarting, or dead)."
            docker compose -f docker-compose.dev.yml logs
            exit 1
          fi
      
          echo "All containers are running as expected."
      - name: Stop and Remove Containers
        if: always()
        run: |
          cd FogNode
          docker compose -f docker-compose.dev.yml down --remove-orphans
